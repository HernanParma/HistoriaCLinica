<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; style-src 'self' 'unsafe-inline'; font-src 'self' data:; script-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' https://historia.runasp.net https://localhost:5156;">
    <title>Historia Clínica del Paciente</title>
    <link rel="stylesheet" href="css/styles.css">
    <!-- Font Awesome local -->
    <link rel="stylesheet" href="lib/fontawesome/css/all.min.css">
    <style>
    /* ESTILOS INLINE PARA CONSULTAS Y FORMULARIO DE ARCHIVOS */
    
    /* Contenedor principal */
    .hc-section {
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%) !important;
        border-radius: 24px !important;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.08) !important;
        padding: 0 !important;
        overflow: hidden !important;
        border: 1px solid #e2e8f0 !important;
        margin: 20px 0 !important;
        position: relative !important;
    }
    
    .hc-section::before {
        content: '' !important;
        position: absolute !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        height: 4px !important;
        background: linear-gradient(90deg, #667eea 0%, #764ba2 0%, #f093fb 100%) !important;
        z-index: 10 !important;
    }
    
    /* Títulos */
    .hc-section h3 {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        color: white !important;
        margin: 0 !important;
        padding: 20px 24px !important;
        font-size: 1.3em !important;
        font-weight: 700 !important;
        display: flex !important;
        align-items: center !important;
        gap: 12px !important;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
        position: relative !important;
        border: none !important;
    }
    
    .hc-section h4 {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        color: white !important;
        margin: 0 !important;
        padding: 16px 24px !important;
        font-size: 1.1em !important;
        font-weight: 700 !important;
        display: flex !important;
        align-items: center !important;
        gap: 10px !important;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
        position: relative !important;
        border: none !important;
    }
    
    /* Botón de historial */
    #btnMostrarHistorial {
        background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%) !important;
        border: 2px solid #cbd5e1 !important;
        color: #475569 !important;
        padding: 12px 20px !important;
        border-radius: 13px !important;
        font-weight: 600 !important;
        font-size: 0.9em !important;
        cursor: pointer !important;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
        display: flex !important;
        align-items: center !important;
        gap: 8px !important;
        margin: 16px 24px !important;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05) !important;
        position: relative !important;
        overflow: hidden !important;
        text-decoration: none !important;
        outline: none !important;
    }
    
    #btnMostrarHistorial:hover {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        color: white !important;
        border-color: #667eea !important;
        transform: translateY(-2px) !important;
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3) !important;
    }
    
    /* Modal para Nueva Consulta */
    .modal {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100% !important;
        height: 100% !important;
        background: rgba(0, 0, 0, 0.5) !important;
        display: flex !important;
        justify-content: center !important;
        align-items: center !important;
        z-index: 1000 !important;
        opacity: 0 !important;
        visibility: hidden !important;
        transition: all 0.3s ease !important;
    }

    .modal.show {
        opacity: 1 !important;
        visibility: visible !important;
    }

    .modal.hidden {
        display: none !important;
    }

    .modal-content {
        background: white !important;
        border-radius: 16px !important;
        box-shadow: 0 16px 48px rgba(0, 0, 0, 0.3) !important;
        width: 90% !important;
        max-width: 960px !important;
        max-height: 90vh !important;
        overflow-y: auto !important;
        position: relative !important;
        transform: scale(0.9) !important;
        transition: transform 0.3s ease !important;
    }

    .modal.show .modal-content {
        transform: scale(1) !important;
    }

    /* Estilo específico para el modal de editar consulta - más ancho */
    #modalEditarConsulta .modal-content {
        max-width: 1200px !important;
        width: 95% !important;
    }

    .modal-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        color: white !important;
        padding: 16px 20px !important;
        border-radius: 16px 16px 0 0 !important;
        display: flex !important;
        justify-content: space-between !important;
        align-items: center !important;
    }

    .modal-header h3 {
        margin: 0 !important;
        font-size: 1.1em !important;
        font-weight: 600 !important;
        display: flex !important;
        align-items: center !important;
        gap: 8px !important;
    }

    .close-btn {
        background: none !important;
        border: none !important;
        color: white !important;
        font-size: 1.5em !important;
        cursor: pointer !important;
        padding: 5px !important;
        border-radius: 50% !important;
        transition: background 0.3s ease !important;
    }

    .close-btn:hover {
        background: rgba(255, 255, 255, 0.2) !important;
    }

    .modal-body {
        padding: 20px !important;
    }

    .form-group {
        margin-bottom: 16px !important;
    }

    .form-group label {
        display: block !important;
        margin-bottom: 6px !important;
        font-weight: 600 !important;
        color: #374151 !important;
        font-size: 0.85em !important;
    }

    .form-group input,
    .form-group textarea {
        width: 100% !important;
        padding: 10px 12px !important;
        border: 2px solid #e5e7eb !important;
        border-radius: 10px !important;
        font-size: 13px !important;
        transition: border-color 0.3s ease !important;
        font-family: inherit !important;
        box-sizing: border-box !important;
    }

    .form-group input:focus,
    .form-group textarea:focus {
        outline: none !important;
        border-color: #667eea !important;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1) !important;
    }

    .form-group textarea {
        resize: vertical !important;
        min-height: 60px !important;
    }

    /* Estilos para sección de laboratorio */
    .form-section {
        margin: 25px 0 !important;
        padding: 20px !important;
        background: #f8fafc !important;
        border-radius: 12px !important;
        border: 1px solid #e2e8f0 !important;
    }

    .form-section h4 {
        margin: 0 0 20px 0 !important;
        color: #374151 !important;
        font-size: 1.1em !important;
        font-weight: 600 !important;
        display: flex !important;
        align-items: center !important;
        gap: 8px !important;
    }

    .lab-grid {
        display: grid !important;
        grid-template-columns: repeat(6, 1fr) !important;
        gap: 15px !important;
    }

    /* Asegurar que el grid de laboratorio en el modal de editar consulta use 5 columnas */
    #modalEditarConsulta .lab-grid {
        grid-template-columns: repeat(6, 1fr) !important;
    }

    /* Asegurar que los elementos del grid se ajusten correctamente */
    .lab-grid .form-group {
        min-width: 0 !important;
        max-width: none !important;
    }

    .lab-grid .form-group {
        margin-bottom: 15px !important;
    }

    .lab-grid .form-group input {
        padding: 10px 12px !important;
        font-size: 13px !important;
    }

    .lab-grid .form-group.full-width {
        grid-column: 1 / -1 !important;
    }

    /* Estilos para el campo de fecha inline en laboratorio */
    .date-inline {
        font-weight: normal !important;
        color: #4a5568 !important;
        margin-left: 20px !important;
    }

    .date-inline input[type="date"] {
        margin-left: 8px !important;
        padding: 6px 10px !important;
        border: 1px solid #e2e8f0 !important;
        border-radius: 6px !important;
        font-size: 13px !important;
        background: white !important;
        transition: border-color 0.3s ease !important;
        width: 140px !important;
    }

    .date-inline input[type="date"]:focus {
        border-color: #667eea !important;
        outline: none !important;
        box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1) !important;
    }

    /* Estilos para labels de laboratorio clickeables */
    .lab-grid .form-group label {
        cursor: pointer !important;
        transition: color 0.3s ease !important;
        user-select: none !important;
    }

    .lab-grid .form-group label:hover {
        color: #e53e3e !important;
    }

    .lab-grid .form-group label.highlighted {
        color: #e53e3e !important;
        font-weight: bold !important;
        text-shadow: 0 0 3px rgba(229, 62, 62, 0.3) !important;
    }

    /* Estilos para labels resaltados en consultas guardadas */
    .lab-label.highlighted {
        color: #e53e3e !important;
        font-weight: bold !important;
        text-shadow: 0 0 3px rgba(229, 62, 62, 0.3) !important;
    }

    /* Estilos para la fecha del laboratorio */
    .lab-date-info {
        background: #f7fafc !important;
        border: 1px solid #e2e8f0 !important;
        border-radius: 8px !important;
        padding: 12px 16px !important;
        margin-bottom: 16px !important;
        font-size: 14px !important;
        color: #4a5568 !important;
    }

    .lab-date-info strong {
        color: #2d3748 !important;
        font-weight: 600 !important;
    }



    /* Estilos para archivos */
    .file-upload-area {
        padding: 20px !important;
        border: 2px dashed #d1d5db !important;
        border-radius: 12px !important;
        background: #f9fafb !important;
        text-align: center !important;
        transition: all 0.3s ease !important;
    }

    .file-upload-area:hover {
        border-color: #667eea !important;
        background: #f0f4ff !important;
    }

    .file-input-container {
        position: relative !important;
        display: inline-block !important;
        width: 100% !important;
    }

    .file-input {
        position: absolute !important;
        opacity: 0 !important;
        width: 100% !important;
        height: 100% !important;
        cursor: pointer !important;
    }

    .file-input-label {
        display: flex !important;
        flex-direction: column !important;
        align-items: center !important;
        gap: 10px !important;
        padding: 30px 20px !important;
        cursor: pointer !important;
        color: #6b7280 !important;
        transition: color 0.3s ease !important;
    }

    .file-input-label:hover {
        color: #667eea !important;
    }

    .file-input-label i {
        font-size: 2em !important;
        color: #9ca3af !important;
    }

    .file-input-label span {
        font-weight: 600 !important;
        font-size: 1.1em !important;
    }

    .file-input-label small {
        color: #9ca3af !important;
        font-size: 0.9em !important;
    }

    .archivos-seleccionados {
        margin-top: 20px !important;
        text-align: left !important;
    }

    .archivo-item {
        display: flex !important;
        align-items: center !important;
        justify-content: space-between !important;
        padding: 10px 15px !important;
        background: white !important;
        border: 1px solid #e5e7eb !important;
        border-radius: 8px !important;
        margin-bottom: 8px !important;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05) !important;
    }

    .archivo-info {
        display: flex !important;
        align-items: center !important;
        gap: 10px !important;
    }

    .archivo-icono {
        width: 24px !important;
        height: 24px !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        border-radius: 4px !important;
        font-size: 12px !important;
        color: white !important;
    }

    .archivo-icono.pdf { background: #ef4444 !important; }
    .archivo-icono.image { background: #10b981 !important; }
    .archivo-icono.document { background: #3b82f6 !important; }
    .archivo-icono.spreadsheet { background: #059669 !important; }

    .archivo-nombre {
        font-weight: 500 !important;
        color: #374151 !important;
        font-size: 0.9em !important;
    }

    .archivo-tamaño {
        color: #6b7280 !important;
        font-size: 0.8em !important;
    }

    .btn-eliminar-archivo {
        background: #ef4444 !important;
        color: white !important;
        border: none !important;
        border-radius: 4px !important;
        padding: 4px 8px !important;
        cursor: pointer !important;
        font-size: 12px !important;
        transition: background 0.3s ease !important;
    }

    .btn-eliminar-archivo:hover {
        background: #dc2626 !important;
    }

    /* Botón de eliminar consulta con icono de papelera - ROJO TENUE */
    .btn-eliminar-consulta {
        background: linear-gradient(135deg, #fca5a5 0%, #f87171 100%) !important;
        color: #dc2626 !important;
        border: 2px solid #fecaca !important;
        border-radius: 10px !important;
        padding: 10px 14px !important;
        font-size: 0.95em !important;
        font-weight: 600 !important;
        cursor: pointer !important;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
        display: flex !important;
        align-items: center !important;
        gap: 8px !important;
        box-shadow: 0 3px 12px rgba(248, 113, 113, 0.25) !important;
        min-width: 120px !important;
        height: 40px !important;
        justify-content: center !important;
        backdrop-filter: blur(10px) !important;
        position: relative !important;
    }

    .btn-eliminar-consulta:hover {
        background: linear-gradient(135deg, #f87171 0%, #ef4444 100%) !important;
        color: white !important;
        border-color: #fca5a5 !important;
        transform: translateY(-3px) scale(1.05) !important;
        box-shadow: 0 6px 20px rgba(248, 113, 113, 0.35) !important;
    }

    .btn-eliminar-consulta:active {
        transform: translateY(-1px) scale(1.02) !important;
        box-shadow: 0 3px 12px rgba(248, 113, 113, 0.25) !important;
    }

    .btn-eliminar-consulta i {
        font-size: 1.1em !important;
        color: inherit !important;
        transition: all 0.3s ease !important;
    }

    .btn-eliminar-consulta:hover i {
        transform: scale(1.1) !important;
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1)) !important;
    }

    /* Efectos adicionales para el botón de eliminar */
    .btn-eliminar-consulta::before {
        content: '' !important;
        position: absolute !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%) !important;
        border-radius: 10px !important;
        opacity: 0 !important;
        transition: opacity 0.3s ease !important;
        pointer-events: none !important;
    }

    .btn-eliminar-consulta:hover::before {
        opacity: 1 !important;
    }

    /* Animación de pulso sutil en hover */
    @keyframes pulse-soft {
        0% { transform: scale(1); }
        50% { transform: scale(1.02); }
        100% { transform: scale(1); }
    }

    .btn-eliminar-consulta:hover {
        animation: pulse-soft 2s infinite !important;
    }

    /* Efecto de brillo sutil en hover */
    .btn-eliminar-consulta::after {
        content: '' !important;
        position: absolute !important;
        top: -2px !important;
        left: -2px !important;
        right: -2px !important;
        bottom: -2px !important;
        background: linear-gradient(135deg, #fecaca 0%, #fca5a5 50%, #f87171 100%) !important;
        border-radius: 12px !important;
        z-index: -1 !important;
        opacity: 0 !important;
        transition: opacity 0.3s ease !important;
    }

    .btn-eliminar-consulta:hover::after {
        opacity: 0.3 !important;
    }

    /* Estado de focus para accesibilidad */
    .btn-eliminar-consulta:focus {
        outline: none !important;
        box-shadow: 0 0 0 3px rgba(248, 113, 113, 0.4), 0 3px 12px rgba(248, 113, 113, 0.25) !important;
    }

    .btn-eliminar-consulta:focus-visible {
        outline: 2px solid #f87171 !important;
        outline-offset: 2px !important;
    }

    /* Botón para ver laboratorio */
    .btn-ver-laboratorio {
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%) !important;
        color: white !important;
        border: none !important;
        border-radius: 8px !important;
        padding: 8px 16px !important;
        font-size: 0.9em !important;
        font-weight: 600 !important;
        cursor: pointer !important;
        transition: all 0.3s ease !important;
        display: inline-flex !important;
        align-items: center !important;
        gap: 8px !important;
        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3) !important;
        margin-top: 15px !important;
    }

    .btn-ver-laboratorio:hover {
        background: linear-gradient(135deg, #1d4ed8 0%, #1e40af 100%) !important;
        transform: translateY(-2px) !important;
        box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4) !important;
    }

    .btn-ver-laboratorio.active {
        background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%) !important;
        box-shadow: 0 4px 15px rgba(220, 38, 38, 0.4) !important;
    }

    .btn-ver-laboratorio i {
        font-size: 1em !important;
    }

    /* Sección de laboratorio */
    .laboratorio-section {
        margin-top: 20px !important;
        padding: 20px !important;
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%) !important;
        border-radius: 12px !important;
        border: 1px solid #e2e8f0 !important;
    }

    .laboratorio-section.hidden {
        display: none !important;
    }

    .laboratorio-section.show {
        display: block !important;
        animation: slideDown 0.3s ease-out !important;
    }

    .laboratorio-grid {
        display: grid !important;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)) !important;
        gap: 15px !important;
    }

    .lab-value-item {
        display: flex !important;
        justify-content: space-between !important;
        align-items: center !important;
        padding: 8px 12px !important;
        background: white !important;
        border-radius: 6px !important;
        border: 1px solid #e2e8f0 !important;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1) !important;
    }

    .lab-label {
        font-weight: 600 !important;
        color: #374151 !important;
        font-size: 0.8em !important;
    }

    .lab-value {
        font-weight: 700 !important;
        color: #1e40af !important;
        font-size: 0.9em !important;
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%) !important;
        padding: 3px 10px !important;
        border-radius: 16px !important;
        border: 1px solid #93c5fd !important;
    }

    .no-lab-values {
        text-align: center !important;
        color: #6b7280 !important;
        font-style: italic !important;
        padding: 20px !important;
    }

    /* Acciones inferiores de la consulta */
    .consulta-actions-bottom {
        margin-top: 20px !important;
        padding-top: 15px !important;
        border-top: 1px solid #e2e8f0 !important;
        text-align: center !important;
    }

    /* Estilos para datos del paciente editables */
    .patient-data-container {
        padding: 0 !important;
    }

    .patient-section {
        margin-bottom: 25px !important;
        background: white !important;
        border-radius: 12px !important;
        padding: 20px !important;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;
        border: 1px solid #e2e8f0 !important;
    }

    .patient-section h4 {
        margin: 0 0 20px 0 !important;
        color: #374151 !important;
        font-size: 1.1em !important;
        font-weight: 600 !important;
        display: flex !important;
        align-items: center !important;
        gap: 10px !important;
        padding-bottom: 10px !important;
        border-bottom: 2px solid #667eea !important;
    }

    .patient-section h4 i {
        color: #667eea !important;
        font-size: 1em !important;
    }

    .editable-field {
        margin-bottom: 15px !important;
        display: flex !important;
        flex-direction: column !important;
        gap: 8px !important;
    }

    .editable-field label {
        font-weight: 600 !important;
        color: #374151 !important;
        font-size: 0.9em !important;
        margin-bottom: 5px !important;
    }

    .editable-field input,
    .editable-field textarea {
        padding: 10px 12px !important;
        border: 2px solid #e2e8f0 !important;
        border-radius: 8px !important;
        font-size: 0.9em !important;
        transition: all 0.3s ease !important;
        background: #f8fafc !important;
        width: 100% !important;
        box-sizing: border-box !important;
    }

    .editable-field input:focus,
    .editable-field textarea:focus {
        outline: none !important;
        border-color: #667eea !important;
        background: white !important;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1) !important;
    }

    .editable-field textarea {
        resize: vertical !important;
        min-height: 80px !important;
        font-family: inherit !important;
    }

    /* ===== NUEVO SISTEMA DE EDICIÓN POR SECCIONES ===== */
    
    /* Encabezado de sección con botón de editar */
    .section-header {
        display: flex !important;
        justify-content: space-between !important;
        align-items: center !important;
        margin-bottom: 15px !important;
        padding-bottom: 10px !important;
        border-bottom: 2px solid #e2e8f0 !important;
    }
    
    .section-header h4 {
        margin: 0 !important;
        background: none !important;
        color: #1e293b !important;
        padding: 0 !important;
        font-size: 1.2em !important;
        font-weight: 600 !important;
        text-shadow: none !important;
        border: none !important;
    }
    
    /* Botón de editar sección */
    .btn-edit-section {
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%) !important;
        color: white !important;
        border: none !important;
        border-radius: 8px !important;
        padding: 8px 16px !important;
        font-size: 0.9em !important;
        font-weight: 600 !important;
        cursor: pointer !important;
        transition: all 0.3s ease !important;
        display: inline-flex !important;
        align-items: center !important;
        gap: 8px !important;
        min-width: 100px !important;
        justify-content: center !important;
    }
    
    .btn-edit-section:hover {
        transform: translateY(-2px) !important;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3) !important;
    }
    
    .btn-edit-section.editing {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%) !important;
    }
    
    .btn-edit-section.editing:hover {
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3) !important;
    }
    
    /* Contenedor de acciones de sección */
    .section-actions {
        display: flex !important;
        justify-content: center !important;
        margin-top: 20px !important;
        padding-top: 15px !important;
        border-top: 1px solid #e2e8f0 !important;
    }
    
    .section-actions.hidden {
        display: none !important;
    }
    
    /* Botón de guardar sección */
    .btn-save-section {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important;
        color: white !important;
        border: none !important;
        border-radius: 8px !important;
        padding: 12px 24px !important;
        font-size: 1em !important;
        font-weight: 600 !important;
        cursor: pointer !important;
        transition: all 0.3s ease !important;
        display: inline-flex !important;
        align-items: center !important;
        gap: 10px !important;
        min-width: 120px !important;
        justify-content: center !important;
    }
    
    .btn-save-section:hover {
        transform: translateY(-2px) !important;
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3) !important;
    }
    
    /* Estilos para campos deshabilitados */
    .editable-field input:disabled,
    .editable-field textarea:disabled {
        background-color: #f8fafc !important;
        color: #64748b !important;
        border-color: #e2e8f0 !important;
        cursor: not-allowed !important;
    }
    
    .editable-field input:disabled::placeholder,
    .editable-field textarea:disabled::placeholder {
        color: #94a3b8 !important;
    }
    
    /* Mensajes de éxito y error */
    .success-message {
        background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%) !important;
        color: #065f46 !important;
        border: 1px solid #10b981 !important;
        border-radius: 8px !important;
        padding: 12px 16px !important;
        margin-bottom: 20px !important;
        display: flex !important;
        align-items: center !important;
        gap: 10px !important;
        font-weight: 500 !important;
        box-shadow: 0 2px 8px rgba(16, 185, 129, 0.1) !important;
    }
    
    .error-message {
        background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%) !important;
        color: #991b1b !important;
        border: 1px solid #ef4444 !important;
        border-radius: 8px !important;
        padding: 12px 16px !important;
        margin-bottom: 20px !important;
        display: flex !important;
        align-items: center !important;
        gap: 10px !important;
        font-weight: 500 !important;
        box-shadow: 0 2px 8px rgba(239, 68, 68, 0.1) !important;
    }
    
    /* Clase para ocultar elementos */
    .hidden {
        display: none !important;
    }

    /* ===== ESTILOS PARA MODALES DE MEDICACIÓN Y ANTECEDENTES ===== */
    
    /* Contenido de medicación y antecedentes */
    .medicacion-content,
    .antecedentes-content {
        padding: 0 !important;
    }
    
    .medicacion-info,
    .antecedentes-info {
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%) !important;
        border-radius: 12px !important;
        padding: 25px !important;
        margin-bottom: 20px !important;
        border: 1px solid #e2e8f0 !important;
        min-height: 200px !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
    }
    
    .medicacion-info p,
    .antecedentes-info p {
        margin: 0 !important;
        font-size: 1.1em !important;
        line-height: 1.6 !important;
        color: #374151 !important;
        text-align: center !important;
        font-weight: 500 !important;
        white-space: pre-wrap !important;
        word-wrap: break-word !important;
    }
    
    .medicacion-info p:empty::before,
    .antecedentes-info p:empty::before {
        content: "No hay información registrada." !important;
        color: #9ca3af !important;
        font-style: italic !important;
    }
    
    /* Acciones del modal */
    .modal-actions {
        display: flex !important;
        justify-content: center !important;
        gap: 15px !important;
        padding-top: 20px !important;
        border-top: 1px solid #e2e8f0 !important;
    }
    
    /* Botón de cerrar modal */
    .btn-close-modal {
        background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%) !important;
        color: white !important;
        border: none !important;
        border-radius: 8px !important;
        padding: 12px 24px !important;
        font-size: 1em !important;
        font-weight: 600 !important;
        cursor: pointer !important;
        transition: all 0.3s ease !important;
        display: inline-flex !important;
        align-items: center !important;
        gap: 8px !important;
        min-width: 120px !important;
        justify-content: center !important;
    }
    
    .btn-close-modal:hover {
        transform: translateY(-2px) !important;
        box-shadow: 0 4px 12px rgba(107, 114, 128, 0.3) !important;
    }

    /* Optimizaciones adicionales para mejor uso del espacio */
    .form-header {
        margin-bottom: 20px !important;
        padding: 15px 0 !important;
    }

    .form-header h2 {
        margin: 0 !important;
        font-size: 1.5em !important;
    }

    .header-buttons {
        gap: 12px !important;
    }

    /* Mejorar densidad de información en consultas */
    .consulta-item .consulta-content p {
        margin: 8px 0 !important;
        line-height: 1.4 !important;
    }

    .consulta-item .consulta-content strong {
        color: #374151 !important;
        font-weight: 600 !important;
    }

    /* Optimizar espaciado general */
    .hc-body {
        padding: 0 !important;
    }

    /* Hacer el contenido más compacto */
    .form-card {
        margin: 0 !important;
        padding: 0 !important;
    }

    /* Optimizar el layout de las consultas para mejor densidad */
    .consulta-fecha {
        display: flex !important;
        align-items: center !important;
        gap: 8px !important;
        font-weight: 600 !important;
        color: #1e293b !important;
    }

    .consulta-fecha i {
        color: #667eea !important;
        font-size: 0.9em !important;
    }

    .consulta-actions {
        display: flex !important;
        align-items: center !important;
        gap: 10px !important;
    }

    .toggle-icon {
        color: #6b7280 !important;
        transition: transform 0.3s ease !important;
        cursor: pointer !important;
        font-size: 0.9em !important;
    }

    /* Mejorar la densidad de información en el contenido */
    .consulta-details {
        display: grid !important;
        gap: 8px !important;
    }

    .detail-item {
        padding: 6px 0 !important;
        border-bottom: 1px solid #f3f4f6 !important;
    }

    .detail-item:last-child {
        border-bottom: none !important;
    }

    .detail-item strong {
        color: #374151 !important;
        font-weight: 600 !important;
        margin-right: 8px !important;
    }

    /* Estados colapsado/expandido para consultas */
    .consulta-content.collapsed {
        display: none !important;
    }

    .consulta-content.expanded {
        display: block !important;
        animation: slideDown 0.3s ease-out !important;
    }

    @keyframes slideDown {
        from {
            opacity: 0 !important;
            transform: translateY(-10px) !important;
        }
        to {
            opacity: 1 !important;
            transform: translateY(0) !important;
        }
    }

    /* Hover mejorado para las consultas */
    .consulta-item:hover .consulta-header {
        background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%) !important;
    }

    .consulta-item:hover .toggle-icon {
        color: #667eea !important;
    }

    .form-actions {
        display: flex !important;
        gap: 15px !important;
        justify-content: flex-end !important;
        margin-top: 30px !important;
        padding-top: 20px !important;
        border-top: 1px solid #e5e7eb !important;
    }

    .btn {
        padding: 10px 20px !important;
        border: none !important;
        border-radius: 10px !important;
        font-weight: 600 !important;
        font-size: 13px !important;
        cursor: pointer !important;
        transition: all 0.3s ease !important;
        display: inline-flex !important;
        align-items: center !important;
        gap: 6px !important;
        text-decoration: none !important;
    }

    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        color: white !important;
    }

    .btn-primary:hover {
        transform: translateY(-2px) !important;
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3) !important;
    }

    .btn-success {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important;
        color: white !important;
    }

    .btn-success:hover {
        transform: translateY(-2px) !important;
        box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3) !important;
    }

    .btn-secondary {
        background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%) !important;
        color: white !important;
    }

    .btn-secondary:hover {
        transform: translateY(-2px) !important;
        box-shadow: 0 8px 25px rgba(107, 114, 128, 0.3) !important;
    }

    /* Estilos para el botón Nueva Consulta */
    #btnNuevaConsulta {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important;
        color: white !important;
        border: none !important;
        padding: 10px 16px !important;
        border-radius: 10px !important;
        font-weight: 600 !important;
        font-size: 13px !important;
        cursor: pointer !important;
        transition: all 0.3s ease !important;
        display: inline-flex !important;
        align-items: center !important;
        gap: 6px !important;
        text-decoration: none !important;
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2) !important;
    }

    #btnNuevaConsulta:hover {
        transform: translateY(-2px) !important;
        box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3) !important;
    }

    /* Estilos para botones de consulta */
    .btn-editar-consulta {
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%) !important;
        color: white !important;
        border: none !important;
        padding: 6px 10px !important;
        border-radius: 6px !important;
        font-weight: 600 !important;
        font-size: 11px !important;
        cursor: pointer !important;
        transition: all 0.3s ease !important;
        display: inline-flex !important;
        align-items: center !important;
        gap: 4px !important;
        margin-right: 6px !important;
        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2) !important;
    }

    .btn-editar-consulta:hover {
        transform: translateY(-1px) !important;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3) !important;
    }

    .btn-eliminar-consulta {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%) !important;
        color: white !important;
        border: none !important;
        padding: 6px 10px !important;
        border-radius: 6px !important;
        font-weight: 600 !important;
        font-size: 11px !important;
        cursor: pointer !important;
        transition: all 0.3s ease !important;
        display: inline-flex !important;
        align-items: center !important;
        gap: 4px !important;
        margin-right: 6px !important;
        box-shadow: 0 2px 8px rgba(239, 68, 68, 0.2) !important;
    }

    .btn-eliminar-consulta:hover {
        transform: translateY(-1px) !important;
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3) !important;
    }

    /* Consultas individuales - OPTIMIZADAS para mejor uso del espacio */
    .consulta-item {
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%) !important;
        border-radius: 12px !important;
        border: 1px solid #e2e8f0 !important;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08) !important;
        margin-bottom: 15px !important;
        overflow: hidden !important;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
        position: relative !important;
        padding: 0 !important;
    }
    
    .consulta-item:hover {
        transform: translateY(-2px) !important;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12) !important;
        border-color: #667eea !important;
    }
    
    .consulta-header {
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%) !important;
        padding: 12px 16px !important;
        border-bottom: 1px solid #e2e8f0 !important;
        display: flex !important;
        align-items: center !important;
        justify-content: space-between !important;
        flex-wrap: wrap !important;
        gap: 10px !important;
        margin: 0 !important;
    }
    
    .consulta-header h5 {
        margin: 0 !important;
        font-size: 0.9em !important;
        font-weight: 700 !important;
        color: #1e293b !important;
        display: flex !important;
        align-items: center !important;
        gap: 8px !important;
        padding: 0 !important;
    }
    
    .consulta-motivo {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        color: white !important;
        padding: 6px 14px !important;
        border-radius: 16px !important;
        font-size: 0.9em !important;
        font-weight: 600 !important;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1) !important;
        box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3) !important;
        backdrop-filter: blur(10px) !important;
        display: inline-block !important;
        max-width: 200px !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
        white-space: nowrap !important;
    }
    
    .consulta-content {
        padding: 14px 16px !important;
        background: #ffffff !important;
        margin: 0 !important;
    }
    
    /* Formulario de archivos */
    .file-upload-container {
        margin: 40px 0 !important;
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%) !important;
        border-radius: 20px !important;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.08) !important;
        overflow: hidden !important;
        border: 1px solid #e2e8f0 !important;
        position: relative !important;
        padding: 0 !important;
    }
    
    .file-upload-title {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        color: white !important;
        margin: 0 !important;
        padding: 25px 30px !important;
        font-size: 1.5em !important;
        font-weight: 700 !important;
        display: flex !important;
        align-items: center
         !important;
        gap: 15px !important;
        position: relative !important;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
        border: none !important;
    }
    
    .file-upload-area {
        border: 3px dashed #e2e8f0 !important;
        border-radius: 16px !important;
        padding: 60px 40px !important;
        text-align: center !important;
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%) !important;
        cursor: pointer !important;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1) !important;
        margin: 30px !important;
        position: relative !important;
        min-height: 280px !important;
        display: flex !important;
        flex-direction: column !important;
        align-items: center !important;
        justify-content: center !important;
        overflow: hidden !important;
    }
    
    .file-upload-area:hover {
        border-color: #667eea !important;
        background: linear-gradient(135deg, #f0f4ff 0%, #f8f5ff 100%) !important;
        transform: translateY(-3px) !important;
        box-shadow: 0 20px 60px rgba(102, 126, 234, 0.15) !important;
    }
    
    .upload-icon {
        font-size: 5em !important;
        color: #667eea !important;
        opacity: 0.9 !important;
        transition: all 0.3s ease !important;
        z-index: 2 !important;
        position: relative !important;
        filter: drop-shadow(0 4px 8px rgba(102, 126, 234, 0.2)) !important;
        display: block !important;
    }
    
    .upload-text h3 {
        font-size: 2.2em !important;
        font-weight: 800 !important;
        color: #1e293b !important;
        margin: 0 0 15px 0 !important;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        -webkit-background-clip: text !important;
        -webkit-text-fill-color: transparent !important;
        background-clip: text !important;
        text-shadow: none !important;
        display: block !important;
    }
    
    .upload-description {
        font-size: 1.2em !important;
        color: #64748b !important;
        margin: 0 0 30px 0 !important;
        font-weight: 500 !important;
        line-height: 1.5 !important;
        display: block !important;
    }
    
    .info-item {
        display: flex !important;
        align-items: center !important;
        gap: 12px !important;
        padding: 12px 16px !important;
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.08) 0%, rgba(118, 75, 162, 0.08) 100%) !important;
        border-radius: 12px !important;
        border: 1px solid rgba(102, 126, 234, 0.15) !important;
        transition: all 0.3s ease !important;
        backdrop-filter: blur(10px) !important;
    }
    
    .info-item:hover {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.12) 0%, rgba(118, 75, 162, 0.12) 100%) !important;
        transform: translateX(8px) !important;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15) !important;
    }
    
    .info-item i {
        color: #667eea !important;
        font-size: 1.2em !important;
        width: 24px !important;
        text-align: center !important;
        filter: drop-shadow(0 2px 4px rgba(102, 126, 234, 0.2)) !important;
    }
    
    .info-item span {
        font-size: 1em !important;
        color: #475569 !important;
        font-weight: 500 !important;
        line-height: 1.4 !important;
    }
    
    .file-list-placeholder {
        text-align: center !important;
        padding: 50px 30px !important;
        color: #94a3b8 !important;
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%) !important;
        border-radius: 16px !important;
        border: 2px dashed #cbd5e1 !important;
        transition: all 0.3s ease !important;
        position: relative !important;
    }
    
    .file-list-placeholder:hover {
        border-color: #667eea !important;
        background: linear-gradient(135deg, #f0f4ff 0%, #f8f5ff 100%) !important;
        transform: translateY(-2px) !important;
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.1) !important;
    }
    
    .file-list-placeholder i {
        font-size: 3.5em !important;
        color: #cbd5e1 !important;
        margin-bottom: 20px !important;
        display: block !important;
        transition: all 0.3s ease !important;
    }
    
    .file-list-placeholder:hover i {
        color: #667eea !important;
        transform: scale(1.1) !important;
    }
    
    .file-list-placeholder p {
        font-size: 1.2em !important;
        font-weight: 600 !important;
        margin: 0 0 8px 0 !important;
        color: #64748b !important;
        display: block !important;
    }
    
    .file-list-placeholder small {
        font-size: 1em !important;
        color: #94a3b8 !important;
        line-height: 1.4 !important;
        display: block !important;
    }
    
    /* Botón de envío */
    .submit-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        border: none !important;
        padding: 18px 35px !important;
        border-radius: 16px !important;
        color: white !important;
        font-size: 1.2em !important;
        font-weight: 700 !important;
        cursor: pointer !important;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3) !important;
        display: flex !important;
        align-items: center !important;
        gap: 12px !important;
        margin: 30px 0 !important;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1) !important;
        position: relative !important;
        overflow: hidden !important;
    }
    
    .submit-btn:hover {
        background: linear-gradient(135deg, #764ba2 0%, #667eea 100%) !important;
        transform: translateY(-3px) !important;
        box-shadow: 0 15px 40px rgba(102, 126, 234, 0.4) !important;
    }
    
    /* Campos del formulario */
    .form-group input {
        width: 100% !important;
        padding: 15px 20px !important;
        border: 2px solid #e2e8f0 !important;
        border-radius: 12px !important;
        font-size: 1em !important;
        transition: all 0.3s ease !important;
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%) !important;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04) !important;
        outline: none !important;
    }
    
    .form-group input:focus {
        outline: none !important;
        border-color: #667eea !important;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1) !important;
        transform: translateY(-1px) !important;
    }
    
    .form-group input[name="fecha"],
    .form-group input[name="motivo"] {
        border-color: #ef4444 !important;
    }
    
    .form-group input[name="recetar"],
    .form-group input[name="ome"] {
        border-color: #667eea !important;
    }

    /* Estilos para controles de revisión */
    .revision-controls {
        margin-top: 8px;
        padding: 8px;
        background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
        border: 1px solid #ffc107;
        border-radius: 8px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .revision-controls .btn {
        font-size: 12px;
        padding: 6px 12px;
        border-radius: 6px;
        font-weight: 600;
    }

    .revision-controls .btn-success {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        border: none;
        color: white;
        transition: all 0.3s ease;
    }

    .revision-controls .btn-success:hover {
        background: linear-gradient(135deg, #218838 0%, #1e7e34 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
    }

    .revision-status {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        background: #d4edda;
        color: #155724;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
    }

    .revision-status i {
        color: #28a745;
    }

    /* Estilos para controles de revisión en historial */
        .revision-controls-historial {
            margin-top: 8px;
            padding: 6px;
            display: inline-block;
        }

    .revision-controls-historial .btn {
        font-size: 11px;
        padding: 4px 8px;
        border-radius: 4px;
        font-weight: 600;
    }

    .revision-status-historial {
        margin-top: 6px;
        display: inline-block;
    }

    .detail-item.recetar-item,
    .detail-item.ome-item {
        position: relative;
        padding-bottom: 8px;
    }
    
    /* Historial de consultas */
    #historialConsultas {
        padding: 0 30px 30px 30px !important;
        background: #ffffff !important;
        margin: 0 !important;
    }
    
    /* Mensajes de error y estado */
    .error-message {
        background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%) !important;
        border: 2px solid #ef4444 !important;
        border-radius: 16px !important;
        padding: 25px !important;
        margin: 20px !important;
        text-align: center !important;
        color: #dc2626 !important;
        box-shadow: 0 8px 25px rgba(239, 68, 68, 0.15) !important;
    }
    
    .error-message i {
        font-size: 3em !important;
        margin-bottom: 15px !important;
        display: block !important;
        color: #ef4444 !important;
    }
    
    .error-message span {
        font-size: 1.2em !important;
        font-weight: 600 !important;
        display: block !important;
        margin-bottom: 10px !important;
    }
    
    .error-message small {
        font-size: 1em !important;
        color: #991b1b !important;
        font-weight: 500 !important;
        line-height: 1.4 !important;
    }
    
    .no-consultations {
        background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%) !important;
        border: 2px dashed #0ea5e9 !important;
        border-radius: 20px !important;
        padding: 60px 40px !important;
        text-align: center !important;
        color: #0369a1 !important;
        margin: 30px !important;
    }
    
    .no-consultations i {
        font-size: 4em !important;
        margin-bottom: 20px !important;
        display: block !important;
        color: #0ea5e9 !important;
        opacity: 0.8 !important;
    }
    
    .no-consultations span {
        font-size: 1.4em !important;
        font-weight: 600 !important;
        display: block !important;
        margin-bottom: 10px !important;
    }
    
    .no-consultations small {
        font-size: 1.1em !important;
        color: #0c4a6e !important;
        font-weight: 500 !important;
        line-height: 1.5 !important;
    }
    
    /* Loading spinner mejorado */
    .loading {
        display: flex !important;
        flex-direction: column !important;
        align-items: center !important;
        justify-content: center !important;
        padding: 60px 40px !important;
        text-align: center !important;
        color: #667eea !important;
    }
    
    .loading i {
        font-size: 3em !important;
        margin-bottom: 20px !important;
        animation: spin 1s linear infinite !important;
    }
    
    .loading span {
        font-size: 1.2em !important;
        font-weight: 600 !important;
        color: #475569 !important;
    }
    
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    
    /* Botones de acción en mensajes de error */
    .btn {
        display: inline-flex !important;
        align-items: center !important;
        gap: 8px !important;
        padding: 12px 20px !important;
        border: none !important;
        border-radius: 8px !important;
        font-size: 1em !important;
        font-weight: 600 !important;
        cursor: pointer !important;
        transition: all 0.3s ease !important;
        text-decoration: none !important;
        outline: none !important;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        color: white !important;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3) !important;
    }
    
    .btn-primary:hover {
        transform: translateY(-2px) !important;
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4) !important;
    }
    
    .btn-secondary {
        background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%) !important;
        color: white !important;
        box-shadow: 0 4px 12px rgba(107, 114, 128, 0.3) !important;
    }
    
    .btn-secondary:hover {
        transform: translateY(-2px) !important;
        box-shadow: 0 8px 25px rgba(107, 114, 128, 0.4) !important;
    }
    
    /* ===== ESTILOS PARA BARRA DE BÚSQUEDA DE PACIENTES ===== */
    
    /* Ajustar layout del header */
    .header {
        display: flex !important;
        align-items: center !important;
        justify-content: space-between !important;
        padding: 15px 20px !important;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1) !important;
        position: relative !important;
        z-index: 100 !important;
    }
    
    .header .logo {
        display: flex !important;
        align-items: center !important;
        gap: 12px !important;
        color: white !important;
        text-decoration: none !important;
        flex-shrink: 0 !important;
    }
    
    .header .logo h1 {
        margin: 0 !important;
        font-size: 1.5em !important;
        font-weight: 700 !important;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
    }
    
    .header .logo i {
        font-size: 1.8em !important;
        color: #f093fb !important;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
    }
    
    .header .nav {
        display: flex !important;
        align-items: center !important;
        gap: 20px !important;
        flex-shrink: 0 !important;
    }
    
    /* Contenedor de búsqueda */
    .search-container {
        position: relative !important;
        flex: 1 !important;
        max-width: 500px !important;
        margin: 0 20px !important;
        z-index: 1000 !important;
    }
    
    /* Caja de búsqueda */
    .search-box {
        position: relative !important;
        display: flex !important;
        align-items: center !important;
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%) !important;
        border: 2px solid #e2e8f0 !important;
        border-radius: 25px !important;
        padding: 8px 16px !important;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08) !important;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
        backdrop-filter: blur(10px) !important;
    }
    
    .search-box:focus-within {
        border-color: #667eea !important;
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15) !important;
        transform: translateY(-2px) !important;
    }
    
    /* Icono de búsqueda */
    .search-icon {
        color: #667eea !important;
        font-size: 1.1em !important;
        margin-right: 12px !important;
        transition: all 0.3s ease !important;
    }
    
    .search-box:focus-within .search-icon {
        color: #764ba2 !important;
        transform: scale(1.1) !important;
    }
    
    /* Input de búsqueda */
    #searchPacientes {
        flex: 1 !important;
        border: none !important;
        outline: none !important;
        background: transparent !important;
        font-size: 0.95em !important;
        color: #374151 !important;
        font-weight: 500 !important;
        padding: 8px 0 !important;
    }
    
    #searchPacientes::placeholder {
        color: #9ca3af !important;
        font-weight: 400 !important;
    }
    
    /* Botón de limpiar búsqueda */
    .clear-search-btn {
        background: none !important;
        border: none !important;
        color: #9ca3af !important;
        cursor: pointer !important;
        padding: 4px !important;
        border-radius: 50% !important;
        transition: all 0.3s ease !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        width: 24px !important;
        height: 24px !important;
    }
    
    .clear-search-btn:hover {
        background: #f3f4f6 !important;
        color: #ef4444 !important;
        transform: scale(1.1) !important;
    }
    
    /* Resultados de búsqueda */
    .search-results {
        position: absolute !important;
        top: 100% !important;
        left: 0 !important;
        right: 0 !important;
        background: white !important;
        border: 1px solid #e2e8f0 !important;
        border-radius: 12px !important;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15) !important;
        max-height: 400px !important;
        overflow-y: auto !important;
        z-index: 1001 !important;
        margin-top: 8px !important;
        backdrop-filter: blur(20px) !important;
    }
    
    .search-results.show {
        display: block !important;
        animation: slideDown 0.3s ease-out !important;
    }
    
    /* Item de resultado */
    .search-result-item {
        display: flex !important;
        align-items: center !important;
        padding: 12px 16px !important;
        border-bottom: 1px solid #f3f4f6 !important;
        cursor: pointer !important;
        transition: all 0.3s ease !important;
        position: relative !important;
    }
    
    .search-result-item:last-child {
        border-bottom: none !important;
    }
    
    .search-result-item:hover {
        background: linear-gradient(135deg, #f0f4ff 0%, #f8f5ff 100%) !important;
        transform: translateX(4px) !important;
    }
    
    .search-result-item:active {
        background: linear-gradient(135deg, #e0e7ff 0%, #f0e6ff 100%) !important;
    }
    
    /* Avatar del paciente */
    .patient-avatar {
        width: 40px !important;
        height: 40px !important;
        border-radius: 50% !important;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        color: white !important;
        font-weight: 600 !important;
        font-size: 0.9em !important;
        margin-right: 12px !important;
        flex-shrink: 0 !important;
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3) !important;
    }
    
    /* Información del paciente */
    .patient-info {
        flex: 1 !important;
        min-width: 0 !important;
    }
    
    .patient-name {
        font-weight: 600 !important;
        color: #1e293b !important;
        font-size: 0.95em !important;
        margin-bottom: 2px !important;
        white-space: nowrap !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
    }
    
    .patient-details {
        font-size: 0.8em !important;
        color: #64748b !important;
        display: flex !important;
        align-items: center !important;
        gap: 8px !important;
    }
    
    .patient-dni {
        background: #f1f5f9 !important;
        color: #475569 !important;
        padding: 2px 6px !important;
        border-radius: 4px !important;
        font-weight: 500 !important;
    }
    
    .patient-age {
        color: #667eea !important;
        font-weight: 500 !important;
    }
    
    /* Icono de flecha */
    .result-arrow {
        color: #9ca3af !important;
        font-size: 0.8em !important;
        transition: all 0.3s ease !important;
    }
    
    .search-result-item:hover .result-arrow {
        color: #667eea !important;
        transform: translateX(4px) !important;
    }
    
    /* Mensaje de no resultados */
    .no-results {
        padding: 20px !important;
        text-align: center !important;
        color: #6b7280 !important;
        font-style: italic !important;
    }
    
    .no-results i {
        font-size: 1.5em !important;
        margin-bottom: 8px !important;
        display: block !important;
        color: #9ca3af !important;
    }
    
    /* Loading en búsqueda */
    .search-loading {
        padding: 16px !important;
        text-align: center !important;
        color: #667eea !important;
    }
    
    .search-loading i {
        animation: spin 1s linear infinite !important;
        margin-right: 8px !important;
    }
    
    /* Resaltado de coincidencias */
    .highlight {
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%) !important;
        color: #92400e !important;
        padding: 1px 3px !important;
        border-radius: 3px !important;
        font-weight: 600 !important;
    }
    
    /* Responsive para búsqueda */
    @media (max-width: 768px) {
        .search-container {
            max-width: none !important;
            margin: 0 10px !important;
        }
        
        .search-box {
            padding: 6px 12px !important;
        }
        
        #searchPacientes {
            font-size: 0.9em !important;
        }
        
        .search-results {
            max-height: 300px !important;
        }
        
        .search-result-item {
            padding: 10px 12px !important;
        }
        
        .patient-avatar {
            width: 35px !important;
            height: 35px !important;
            font-size: 0.8em !important;
        }
        
        .patient-name {
            font-size: 0.9em !important;
        }
        
        .patient-details {
            font-size: 0.75em !important;
        }
    }

    /* Responsive */
    @media (max-width: 768px) {
        .consulta-header {
            flex-direction: column !important;
            align-items: flex-start !important;
            gap: 10px !important;
        }
        
        .file-upload-area {
            padding: 40px 25px !important;
            min-height: 240px !important;
            margin: 20px !important;
        }
        
        .upload-text h3 {
            font-size: 1.8em !important;
        }
        
        .error-message {
            margin: 15px !important;
            padding: 20px !important;
        }
        
        .no-consultations {
            margin: 20px !important;
            padding: 40px 25px !important;
        }
    }
    </style>
</head>
<body class="historia">
    <div class="container">
        <header class="header">
            <div class="logo">
                <i class="fas fa-heartbeat"></i>
                <h1>Historia Clínica</h1>
            </div>
            
            <!-- Barra de búsqueda de pacientes -->
            <div class="search-container">
                <div class="search-box">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" id="searchPacientes" placeholder="Buscar pacientes por nombre o apellido..." autocomplete="off">
                    <button id="clearSearch" class="clear-search-btn hidden">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="searchResults" class="search-results hidden">
                    <!-- Los resultados de búsqueda se mostrarán aquí -->
                </div>
            </div>
            
            <nav class="nav">
                <!-- Información del usuario logueado -->
                <div id="user-info" class="user-info">
                    <div class="user-greeting">
                        <span id="userGreeting">Hola!</span>
                        <div class="user-menu">
                            <button id="userMenuBtn" class="user-menu-btn">
                                <i class="fas fa-user-circle"></i>
                                <span id="userName">Usuario</span>
                                <i class="fas fa-chevron-down"></i>
                            </button>
                            <div id="userDropdown" class="user-dropdown hidden">
                                <button id="logoutBtnNav" class="dropdown-item">
                                    <i class="fas fa-sign-out-alt"></i>
                                    Cerrar Sesión
                                </button>
                            </div>
                        </div>
                    </div>
                    <button id="newPatientBtnNav" class="nav-btn btn-primary">
                        <i class="fas fa-user-plus"></i>
                        Registrar Nuevo Paciente
                    </button>
                </div>
            </nav>
        </header>



        <main class="main-content">
            <div class="hc-layout-container">
                <!-- Columna lateral izquierda con datos del paciente -->
                <div id="patient-sidebar" class="patient-sidebar-fixed">
                    <div class="sidebar-header">
                        <h3 id="sidebar-patient-name"><i class="fas fa-user-circle"></i> Datos del Paciente</h3>
                        <button class="btn-edit-sidebar" onclick="toggleEditMode('personal')">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                    </div>
                    <div id="sidebar-content" class="sidebar-content">
                        <!-- Los datos del paciente se cargarán dinámicamente aquí -->
                        <div id="loading-patient-data" class="loading">
                            <i class="fas fa-spinner fa-spin"></i>
                            <span>Cargando datos del paciente...</span>
                        </div>
                    </div>
                </div>

                <!-- Contenido principal de la historia clínica -->
                <div class="hc-main-content">
                    <div id="hc-card" class="form-card hidden">
                        <div class="form-header">
                            <h2><i class="fas fa-stethoscope"></i> Consultas</h2>
                            <div class="header-buttons">
                                <button id="btnNuevaConsulta" class="btn btn-primary">
                                    <i class="fas fa-plus"></i> Nueva Consulta
                                </button>

                                <button id="btnMedicacion" class="btn btn-secondary" onclick="abrirModalMedicacion()">
                                    <i class="fas fa-pills"></i> Medicación
                                </button>

                                <button id="btnAntecedentes" class="btn btn-secondary" onclick="abrirModalAntecedentes()">
                                    <i class="fas fa-history"></i> Antecedentes
                                </button>

                                <a href="index.html" class="btn-back">
                                    <i class="fas fa-arrow-left"></i> Volver
                                </a>
                            </div>
                        </div>
                        <div id="hc-body" class="hc-body">
                            <!-- La historia clínica se cargará dinámicamente aquí -->
                            <div id="loading-hc" class="loading">
                                <i class="fas fa-spinner fa-spin"></i>
                                <span>Cargando historia clínica...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal para Nueva Consulta -->
    <div id="modalNuevaConsulta" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-plus-circle"></i> Nueva Consulta</h3>
                <button id="closeModalNuevaConsulta" class="close-btn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="formNuevaConsulta">
                    <div class="form-group">
                        <label for="fechaConsulta">Fecha de Consulta:</label>
                        <input type="date" id="fechaConsulta" name="fecha" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="motivoConsulta">Motivo de Consulta: *</label>
                        <textarea id="motivoConsulta" name="motivo" rows="3" placeholder="Describa el motivo de la consulta..." required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="recetarConsulta">Recetar:</label>
                        <textarea id="recetarConsulta" name="recetar" rows="2" placeholder="Medicamentos a recetar..."></textarea>
                        <div class="revision-controls" id="recetarControls" style="display: none;">
                            <button type="button" class="btn btn-success btn-sm" id="marcarRecetarRevisado">
                                <i class="fas fa-check"></i> Realizado
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="omeConsulta">OME:</label>
                        <textarea id="omeConsulta" name="ome" rows="2" placeholder="Tratamiento OME..."></textarea>
                        <div class="revision-controls" id="omeControls" style="display: none;">
                            <button type="button" class="btn btn-success btn-sm" id="marcarOmeRevisado">
                                <i class="fas fa-check"></i> Realizado
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="notasConsulta">Notas Adicionales:</label>
                        <textarea id="notasConsulta" name="notas" rows="3" placeholder="Observaciones, recomendaciones..."></textarea>
                    </div>
                    
                    <!-- Campos de Laboratorio -->
                    <div class="form-section">
                        <h4><i class="fas fa-flask"></i> Valores de Laboratorio <span class="date-inline">Fecha: <input type="date" id="fechaLaboratorioConsulta" name="fechaLaboratorio"></span></h4>
                        <div class="lab-grid" data-lab-scope>
                            <!-- Primera fila -->
                            <div class="form-group">
                                <label for="grConsulta">GR:</label>
                                <input type="text" id="grConsulta" name="gr" placeholder="Glóbulos Rojos" pattern="[0-9]+([,][0-9]{1,2})?" inputmode="decimal">
                            </div>
                            <div class="form-group">
                                <label for="htoConsulta">HTO:</label>
                                <input type="text" id="htoConsulta" name="hto" placeholder="Hematocrito" pattern="[0-9]+([,][0-9]{1,2})?" inputmode="decimal">
                            </div>
                            <div class="form-group">
                                <label for="hbConsulta">HB:</label>
                                <input type="text" id="hbConsulta" name="hb" placeholder="Hemoglobina" pattern="[0-9]+([,][0-9]{1,2})?" inputmode="decimal">
                            </div>
                            <div class="form-group">
                                <label for="gbConsulta">GB:</label>
                                <input type="text" id="gbConsulta" name="gb" placeholder="Glóbulos Blancos" pattern="[0-9]+([,][0-9]{1,2})?" inputmode="decimal">
                            </div>
                            <!-- Segunda fila -->
                            <div class="form-group">
                                <label for="plaqConsulta">PLAQ:</label>
                                <input type="text" id="plaqConsulta" name="plaq" placeholder="Plaquetas" pattern="[0-9]+([,][0-9]{1,2})?" inputmode="decimal">
                            </div>
                            <div class="form-group">
                                <label for="glucConsulta">GLUC:</label>
                                <input type="text" id="glucConsulta" name="gluc" placeholder="Glucosa" pattern="[0-9]+([,][0-9]{1,2})?" inputmode="decimal">
                            </div>
                            <div class="form-group">
                                <label for="ureaConsulta">UREA/UREMIA:</label>
                                <input type="text" id="ureaConsulta" name="urea" placeholder="UREA/UREMIA" pattern="[0-9]+([,][0-9]{1,2})?" inputmode="decimal">
                            </div>
                            <div class="form-group">
                                <label for="crConsulta">CR:</label>
                                <input type="text" id="crConsulta" name="cr" placeholder="Creatinina" pattern="[0-9]+([,][0-9]{1,2})?" inputmode="decimal">
                            </div>
                            <div class="form-group">
                                <label for="vfgConsulta">VFG:</label>
                                <input type="text" id="vfgConsulta" name="vfg" placeholder="VFG" pattern="[0-9]+([,][0-9]{1,2})?" inputmode="decimal">
                            </div>
                            <!-- Tercera fila -->
                            <div class="form-group">
                                <label for="gotConsulta">GOT:</label>
                                <input type="text" id="gotConsulta" name="got" placeholder="GOT" pattern="[0-9]+([,][0-9]{1,2})?" inputmode="decimal">
                            </div>
                            <div class="form-group">
                                <label for="gptConsulta">GPT:</label>
                                <input type="text" id="gptConsulta" name="gpt" placeholder="GPT" pattern="[0-9]+([,][0-9]{1,2})?" inputmode="decimal">
                            </div>
                            <div class="form-group">
                                <label for="ctConsulta">CT:</label>
                                <input type="text" id="ctConsulta" name="ct" placeholder="Colesterol Total" pattern="[0-9]+([,][0-9]{1,2})?" inputmode="decimal">
                            </div>
                            <div class="form-group">
                                <label for="tgConsulta">TG:</label>
                                <input type="text" id="tgConsulta" name="tg" placeholder="Triglicéridos" pattern="[0-9]+([,][0-9]{1,2})?" inputmode="decimal">
                            </div>
                            <!-- Cuarta fila -->
                            <div class="form-group">
                                <label for="vitdConsulta">VITD:</label>
                                <input type="text" id="vitdConsulta" name="vitd" placeholder="Vitamina D" pattern="[0-9]+([,][0-9]{1,2})?" inputmode="decimal">
                            </div>
                            <div class="form-group">
                                <label for="falConsulta">FAL:</label>
                                <input type="text" id="falConsulta" name="fal" placeholder="Fosfatasa Alcalina" pattern="[0-9]+([,][0-9]{1,2})?" inputmode="decimal">
                            </div>
                            <div class="form-group">
                                <label for="hdlConsulta">HDL:</label>
                                <input type="text" id="hdlConsulta" name="hdl" placeholder="Colesterol HDL" pattern="[0-9]+([,][0-9]{1,2})?" inputmode="decimal">
                            </div>
                            <div class="form-group">
                                <label for="ldlConsulta">LDL:</label>
                                <input type="text" id="ldlConsulta" name="ldl" placeholder="Colesterol LDL" pattern="[0-9]+([,][0-9]{1,2})?" inputmode="decimal">
                            </div>
                            <div class="form-group">
                                <label for="b12Consulta">B12:</label>
                                <input type="text" id="b12Consulta" name="b12" placeholder="Vitamina B12" pattern="[0-9]+([,][0-9]{1,2})?" inputmode="decimal">
                            </div>
                            <!-- Quinta fila -->
                            <div class="form-group">
                                <label for="tshConsulta">TSH:</label>
                                <input type="text" id="tshConsulta" name="tsh" placeholder="TSH" pattern="[0-9]+([,][0-9]{1,2})?" inputmode="decimal">
                            </div>
                            <div class="form-group">
                                <label for="t4lConsulta">T4L:</label>
                                <input type="text" id="t4lConsulta" name="t4l" placeholder="T4L" pattern="[0-9]+([,][0-9]{1,2})?" inputmode="decimal">
                            </div>
                            <div class="form-group">
                                <label for="uricoConsulta">URICO/URICEMIA:</label>
                                <input type="text" id="uricoConsulta" name="urico" placeholder="URICO/URICEMIA" pattern="[0-9]+([,][0-9]{1,2})?" inputmode="decimal">
                            </div>
                            <div class="form-group">
                                <label for="psaConsulta">PSA:</label>
                                <input type="text" id="psaConsulta" name="psa" placeholder="Antígeno Prostático Específico" pattern="[0-9]+([,][0-9]{1,2})?" inputmode="decimal">
                            </div>
                            <div class="form-group">
                                <label for="hba1cConsulta">HBA1C:</label>
                                <input type="text" id="hba1cConsulta" name="hba1c" placeholder="Hemoglobina Glicosilada" pattern="[0-9]+([,][0-9]{1,2})?" inputmode="decimal">
                            </div>
                            <div class="form-group full-width">
                                <label for="orinaConsulta">ORINA:</label>
                                <input type="text" id="orinaConsulta" name="orina" placeholder="Análisis de orina">
                            </div>
                            
                            <!-- Quinta fila -->
                            <div class="form-group full-width">
                                <label for="valoresNoIncluidosConsulta">Valores no incluidos:</label>
                                <input type="text" id="valoresNoIncluidosConsulta" name="valoresNoIncluidos" placeholder="Otros valores de laboratorio no incluidos">
                            </div>

                        </div>
                    </div>
                    
                    <!-- Sección de Archivos -->
                    <div class="form-section">
                        <h4><i class="fas fa-paperclip"></i> Archivos Adjuntos</h4>
                        <div class="file-upload-area">
                            <div class="file-input-container">
                                <input type="file" id="archivosConsulta" name="archivos" multiple accept=".pdf,.jpg,.jpeg,.png,.gif,.doc,.docx,.xls,.xlsx" class="file-input">
                                <label for="archivosConsulta" class="file-input-label">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                    <span>Seleccionar archivos (PDF, imágenes, documentos)</span>
                                    <small>10MB cada uno</small>
                                </label>
                            </div>
                            <div id="archivosSeleccionados" class="archivos-seleccionados">
                                <!-- Los archivos seleccionados se mostrarán aquí -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save"></i> Guardar Consulta
                        </button>
                        <button type="button" class="btn btn-secondary" id="cancelarNuevaConsulta">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal para Medicación Actual -->
    <div id="modalMedicacion" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-pills"></i> Medicación Actual</h3>
                <button id="closeModalMedicacion" class="close-btn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="medicacion-content">
                    <div class="medicacion-info">
                        <p id="medicacionTexto">No hay información de medicación registrada.</p>
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="btn btn-primary" id="editarModalMedicacion">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                        <button type="button" class="btn btn-secondary" id="cerrarModalMedicacion">
                            <i class="fas fa-times"></i> Cerrar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Antecedentes Médicos -->
    <div id="modalAntecedentes" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-history"></i> Antecedentes Médicos</h3>
                <button id="closeModalAntecedentes" class="close-btn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="antecedentes-content">
                    <div class="antecedentes-info">
                        <p id="antecedentesTexto">No hay antecedentes médicos registrados.</p>
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="btn btn-primary" id="editarModalAntecedentes">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                        <button type="button" class="btn btn-secondary" id="cerrarModalAntecedentes">
                            <i class="fas fa-times"></i> Cerrar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Editar Consulta -->
    <div id="modalEditarConsulta" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-edit"></i> Editar Consulta</h3>
                <button id="closeModalEditarConsulta" class="close-btn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="formEditarConsulta">
                    <div class="form-group">
                        <label for="fechaEditarConsulta">Fecha de Consulta:</label>
                        <input type="date" id="fechaEditarConsulta" name="fecha">
                        <small style="color: #6b7280; font-size: 0.8em; margin-top: 4px; display: block;">Puede modificar la fecha de la consulta</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="motivoEditarConsulta">Motivo de Consulta: *</label>
                        <textarea id="motivoEditarConsulta" name="motivo" rows="3" placeholder="Describa el motivo de la consulta..." required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="recetarEditarConsulta">Recetar:</label>
                        <textarea id="recetarEditarConsulta" name="recetar" rows="2" placeholder="Medicamentos a recetar..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="omeEditarConsulta">OME:</label>
                        <textarea id="omeEditarConsulta" name="ome" rows="2" placeholder="Órdenes médicas especiales..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="notasEditarConsulta">Notas:</label>
                        <textarea id="notasEditarConsulta" name="notas" rows="3" placeholder="Notas adicionales..."></textarea>
                    </div>
                    
                    <!-- Valores de Laboratorio -->
                    <div class="form-group">
                        <label><i class="fas fa-flask"></i> Valores de Laboratorio <span class="date-inline">Fecha: <input type="date" id="fechaLaboratorioEditarConsulta" name="fechaLaboratorio"></span></label>
                        <div class="lab-grid" data-lab-scope>
                            <div class="form-group">
                                <label for="grEditarConsulta">GR:</label>
                                <input type="text" id="grEditarConsulta" name="gr" placeholder="Ej: 4,27">
                            </div>
                            <div class="form-group">
                                <label for="htoEditarConsulta">HTO:</label>
                                <input type="text" id="htoEditarConsulta" name="hto" placeholder="Ej: 38">
                            </div>
                            <div class="form-group">
                                <label for="hbEditarConsulta">HB:</label>
                                <input type="text" id="hbEditarConsulta" name="hb" placeholder="Ej: 12,6">
                            </div>
                            <div class="form-group">
                                <label for="gbEditarConsulta">GB:</label>
                                <input type="text" id="gbEditarConsulta" name="gb" placeholder="Ej: 7220">
                            </div>
                            <div class="form-group">
                                <label for="plaqEditarConsulta">PLAQ:</label>
                                <input type="text" id="plaqEditarConsulta" name="plaq" placeholder="Ej: 250000">
                            </div>
                            <div class="form-group">
                                <label for="glucEditarConsulta">GLUC:</label>
                                <input type="text" id="glucEditarConsulta" name="gluc" placeholder="Ej: 95">
                            </div>
                            <div class="form-group">
                                <label for="ureaEditarConsulta">UREA/UREMIA:</label>
                                <input type="text" id="ureaEditarConsulta" name="urea" placeholder="Ej: 27">
                            </div>
                            <div class="form-group">
                                <label for="crEditarConsulta">CR:</label>
                                <input type="text" id="crEditarConsulta" name="cr" placeholder="Ej: 0,8">
                            </div>
                            <div class="form-group">
                                <label for="vfgEditarConsulta">VFG:</label>
                                <input type="text" id="vfgEditarConsulta" name="vfg" placeholder="Ej: 85">
                            </div>
                            <div class="form-group">
                                <label for="gotEditarConsulta">GOT:</label>
                                <input type="text" id="gotEditarConsulta" name="got" placeholder="Ej: 21">
                            </div>
                            <div class="form-group">
                                <label for="gptEditarConsulta">GPT:</label>
                                <input type="text" id="gptEditarConsulta" name="gpt" placeholder="Ej: 18">
                            </div>
                            <div class="form-group">
                                <label for="ctEditarConsulta">CT:</label>
                                <input type="text" id="ctEditarConsulta" name="ct" placeholder="Ej: 186">
                            </div>
                            <div class="form-group">
                                <label for="tgEditarConsulta">TG:</label>
                                <input type="text" id="tgEditarConsulta" name="tg" placeholder="Ej: 179">
                            </div>
                            <div class="form-group">
                                <label for="vitdEditarConsulta">VITD:</label>
                                <input type="text" id="vitdEditarConsulta" name="vitd" placeholder="Ej: 26">
                            </div>
                            <div class="form-group">
                                <label for="falEditarConsulta">FAL:</label>
                                <input type="text" id="falEditarConsulta" name="fal" placeholder="Ej: 85">
                            </div>
                            <div class="form-group">
                                <label for="hdlEditarConsulta">HDL:</label>
                                <input type="text" id="hdlEditarConsulta" name="hdl" placeholder="Ej: 45">
                            </div>
                            <div class="form-group">
                                <label for="ldlEditarConsulta">LDL:</label>
                                <input type="text" id="ldlEditarConsulta" name="ldl" placeholder="Ej: 100">
                            </div>
                            <div class="form-group">
                                <label for="b12EditarConsulta">B12:</label>
                                <input type="text" id="b12EditarConsulta" name="b12" placeholder="Ej: 400">
                            </div>
                            <div class="form-group">
                                <label for="tshEditarConsulta">TSH:</label>
                                <input type="text" id="tshEditarConsulta" name="tsh" placeholder="Ej: 2,6">
                            </div>
                            <div class="form-group">
                                <label for="t4lEditarConsulta">T4L:</label>
                                <input type="text" id="t4lEditarConsulta" name="t4l" placeholder="Ej: 1,2">
                            </div>
                            <div class="form-group">
                                <label for="uricoEditarConsulta">URICO/URICEMIA:</label>
                                <input type="text" id="uricoEditarConsulta" name="urico" placeholder="Ej: 5,3">
                            </div>
                            <div class="form-group">
                                <label for="psaEditarConsulta">PSA:</label>
                                <input type="text" id="psaEditarConsulta" name="psa" placeholder="Ej: 2,5">
                            </div>
                            <div class="form-group">
                                <label for="hba1cEditarConsulta">HBA1C:</label>
                                <input type="text" id="hba1cEditarConsulta" name="hba1c" placeholder="Ej: 5,8">
                            </div>
                            <div class="form-group full-width">
                                <label for="orinaEditarConsulta">ORINA:</label>
                                <input type="text" id="orinaEditarConsulta" name="orina" placeholder="Ej: S/P">
                            </div>
                            <div class="form-group full-width">
                                <label for="valoresNoIncluidosEditarConsulta">Valores no incluidos:</label>
                                <textarea id="valoresNoIncluidosEditarConsulta" name="valoresNoIncluidos" rows="2" placeholder="Otros valores de laboratorio..."></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <div class="modal-actions">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Guardar Cambios
                        </button>
                        <button type="button" class="btn btn-secondary" id="cancelarEditarConsulta">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script src="js/user-functionality.js"></script>
    <script src="js/historia.js?v=7"></script>
    <script>
    // ===== FUNCIONALIDAD DE BÚSQUEDA DE PACIENTES =====
    
    let allPatients = [];
    let searchTimeout = null;
    
    // Función para obtener todos los pacientes
    async function loadAllPatients() {
        try {
            const token = localStorage.getItem('token');
            const response = await fetch('/api/pacientes', {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            
            if (response.ok) {
                allPatients = await response.json();
                console.log(`📊 Cargados ${allPatients.length} pacientes para búsqueda`);
            } else {
                console.error('Error al cargar pacientes:', response.statusText);
            }
        } catch (error) {
            console.error('Error al cargar pacientes:', error);
        }
    }
    
    // Función para buscar pacientes
    function searchPatients(query) {
        if (!query || query.length < 2) {
            return [];
        }
        
        const searchTerm = query.toLowerCase().trim();
        const words = searchTerm.split(/\s+/);
        
        return allPatients.filter(patient => {
            const fullName = `${patient.nombre} ${patient.apellido}`.toLowerCase();
            const dni = patient.dni ? patient.dni.toString() : '';
            
            // Buscar coincidencias en nombre completo o DNI
            return words.every(word => 
                fullName.includes(word) || dni.includes(word)
            );
        }).slice(0, 10); // Limitar a 10 resultados
    }
    
    // Función para resaltar coincidencias
    function highlightMatches(text, query) {
        if (!query) return text;
        
        const words = query.toLowerCase().trim().split(/\s+/);
        let highlightedText = text;
        
        words.forEach(word => {
            if (word.length > 1) {
                const regex = new RegExp(`(${word})`, 'gi');
                highlightedText = highlightedText.replace(regex, '<span class="highlight">$1</span>');
            }
        });
        
        return highlightedText;
    }
    
    // Función para crear avatar del paciente
    function createPatientAvatar(patient) {
        const initials = `${patient.nombre.charAt(0)}${patient.apellido.charAt(0)}`.toUpperCase();
        return `<div class="patient-avatar">${initials}</div>`;
    }
    
    // Función para calcular edad
    function calculateAge(fechaNacimiento) {
        if (!fechaNacimiento) return '';
        
        const birthDate = new Date(fechaNacimiento);
        const today = new Date();
        let age = today.getFullYear() - birthDate.getFullYear();
        const monthDiff = today.getMonth() - birthDate.getMonth();
        
        if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
            age--;
        }
        
        return age;
    }
    
    // Función para mostrar resultados de búsqueda
    function displaySearchResults(results, query) {
        const resultsContainer = document.getElementById('searchResults');
        
        if (results.length === 0) {
            resultsContainer.innerHTML = `
                <div class="no-results">
                    <i class="fas fa-search"></i>
                    <div>No se encontraron pacientes</div>
                    <small>Intenta con otro nombre o apellido</small>
                </div>
            `;
        } else {
            resultsContainer.innerHTML = results.map(patient => {
                const highlightedName = highlightMatches(`${patient.nombre} ${patient.apellido}`, query);
                const age = calculateAge(patient.fechaNacimiento);
                const dni = patient.dni ? patient.dni.toString() : 'Sin DNI';
                
                return `
                    <div class="search-result-item" data-patient-id="${patient.id}">
                        ${createPatientAvatar(patient)}
                        <div class="patient-info">
                            <div class="patient-name">${highlightedName}</div>
                            <div class="patient-details">
                                <span class="patient-dni">DNI: ${dni}</span>
                                ${age ? `<span class="patient-age">${age} años</span>` : ''}
                            </div>
                        </div>
                        <i class="fas fa-chevron-right result-arrow"></i>
                    </div>
                `;
            }).join('');
        }
        
        resultsContainer.classList.remove('hidden');
        resultsContainer.classList.add('show');
    }
    
    // Función para ocultar resultados
    function hideSearchResults() {
        const resultsContainer = document.getElementById('searchResults');
        resultsContainer.classList.add('hidden');
        resultsContainer.classList.remove('show');
    }
    
    // Función para limpiar búsqueda
    function clearSearch() {
        const searchInput = document.getElementById('searchPacientes');
        const clearBtn = document.getElementById('clearSearch');
        
        searchInput.value = '';
        clearBtn.classList.add('hidden');
        hideSearchResults();
    }
    
    // Función para navegar a paciente
    function navigateToPatient(patientId) {
        window.location.href = `historia.html?id=${patientId}`;
    }
    
    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('searchPacientes');
        const clearBtn = document.getElementById('clearSearch');
        const resultsContainer = document.getElementById('searchResults');
        
        // Cargar pacientes al inicializar
        loadAllPatients();
        
        // Event listener para input de búsqueda
        searchInput.addEventListener('input', function(e) {
            const query = e.target.value.trim();
            
            // Mostrar/ocultar botón de limpiar
            if (query.length > 0) {
                clearBtn.classList.remove('hidden');
            } else {
                clearBtn.classList.add('hidden');
                hideSearchResults();
                return;
            }
            
            // Debounce para evitar muchas búsquedas
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                if (query.length >= 2) {
                    const results = searchPatients(query);
                    displaySearchResults(results, query);
                } else {
                    hideSearchResults();
                }
            }, 300);
        });
        
        // Event listener para botón de limpiar
        clearBtn.addEventListener('click', clearSearch);
        
        // Event listener para resultados de búsqueda
        resultsContainer.addEventListener('click', function(e) {
            const resultItem = e.target.closest('.search-result-item');
            if (resultItem) {
                const patientId = resultItem.dataset.patientId;
                navigateToPatient(patientId);
            }
        });
        
        // Ocultar resultados al hacer clic fuera
        document.addEventListener('click', function(e) {
            const searchContainer = document.querySelector('.search-container');
            if (!searchContainer.contains(e.target)) {
                hideSearchResults();
            }
        });
        
        // Event listener para teclas especiales
        searchInput.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                clearSearch();
            }
        });
    });
    </script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Redirigir a login.html si no está autenticado
        const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
        if (!isLoggedIn) {
            window.location.href = 'login.html';
            return;
        }
        var btnNav = document.getElementById('newPatientBtnNav');
        if (btnNav) {
            btnNav.addEventListener('click', function(e) {
                e.preventDefault();
                window.location.href = 'agregar.html';
            });
        }
        // Lógica de logout
        var logoutBtn = document.getElementById('logoutBtnNav');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', function(e) {
                e.preventDefault();
                localStorage.removeItem('isLoggedIn');
                localStorage.removeItem('username');
                window.location.replace('login.html');
            });
        }
        // Redirección al hacer clic en logo o título
        var logo = document.querySelector('.logo');
        if (logo) {
            logo.style.cursor = 'pointer';
            logo.addEventListener('click', function() {
                window.location.href = 'index.html';
            });
        }

        // Función para manejar el clic en labels de laboratorio
        function setupLabLabelClickHandlers(root = document) {
            // Remover event listeners existentes para evitar duplicados
            root.querySelectorAll('.lab-grid .form-group label').forEach(label => {
                label.removeEventListener('click', handleLabelClick);
            });
            
            const labLabels = root.querySelectorAll('.lab-grid .form-group label');
            console.log(`🔧 Configurando ${labLabels.length} labels de laboratorio en:`, root);
            
            labLabels.forEach(label => {
                label.addEventListener('click', handleLabelClick);
            });
        }
        
        // Función separada para manejar el clic
        function handleLabelClick(event) {
            event.preventDefault();
            event.stopPropagation();
            
            // Verificar que el clic sea en un label válido
            if (!this || !this.classList) return;
            
            // Toggle de la clase highlighted
            this.classList.toggle('highlighted');
            
            // Obtener el nombre del campo de manera más robusta
            const fieldName = this.textContent.replace(':', '').trim();
            const fieldKey = this.getAttribute('for') || this.dataset.key || fieldName.toLowerCase();
            
            if (this.classList.contains('highlighted')) {
                console.log(`🔴 Campo ${fieldName} (${fieldKey}) marcado como fuera de rango`);
            } else {
                console.log(`⚪ Campo ${fieldName} (${fieldKey}) desmarcado`);
            }
        }

        // Función para obtener los campos resaltados
        function getHighlightedFields(root = document) {
            const highlightedFields = [];
            const labLabels = root.querySelectorAll('.lab-grid .form-group label.highlighted');
            
            console.log(`🔍 Buscando campos resaltados en:`, root);
            console.log(`🔍 Labels encontrados con clase highlighted:`, labLabels.length);
            
            labLabels.forEach((label, index) => {
                const fieldName = label.textContent.replace(':', '').trim().toLowerCase();
                const fieldKey = label.getAttribute('for') || label.dataset.key || fieldName;
                
                // Normalizar la clave removiendo sufijos comunes
                let normalizedKey = fieldKey.toLowerCase()
                    .replace(/editarconsulta$/i, '')
                    .replace(/consulta$/i, '')
                    .replace(/editar$/i, '');
                
                // Si la clave normalizada está vacía, usar el nombre del campo
                if (!normalizedKey || normalizedKey.length === 0) {
                    normalizedKey = fieldName;
                }
                
                highlightedFields.push(normalizedKey);
                console.log(`  ${index + 1}. ${fieldName} -> ${fieldKey} -> ${normalizedKey}`);
            });
            
            console.log('🔍 Campos resaltados encontrados:', highlightedFields);
            return highlightedFields;
        }

        // Función para aplicar campos resaltados
        function applyHighlightedFields(highlightedFields, root = document) {
            if (!highlightedFields || highlightedFields.length === 0) return;
            
            const labLabels = root.querySelectorAll('.lab-grid .form-group label');
            console.log(`🔧 Aplicando ${highlightedFields.length} campos resaltados en:`, root);
            
            labLabels.forEach(label => {
                const fieldName = label.textContent.replace(':', '').trim().toLowerCase();
                const fieldKey = label.getAttribute('for') || label.dataset.key || fieldName;
                
                // Usar la misma lógica de normalización que en getHighlightedFields
                let normalizedKey = fieldKey.toLowerCase()
                    .replace(/editarconsulta$/i, '')
                    .replace(/consulta$/i, '')
                    .replace(/editar$/i, '');
                
                if (!normalizedKey || normalizedKey.length === 0) {
                    normalizedKey = fieldName;
                }
                
                if (highlightedFields.includes(normalizedKey)) {
                    label.classList.add('highlighted');
                    console.log(`✅ Campo ${fieldName} (${normalizedKey}) resaltado`);
                }
            });
        }

        // Función para limpiar campos resaltados
        function clearHighlightedFields(root = document) {
            const labLabels = root.querySelectorAll('.lab-grid .form-group label');
            labLabels.forEach(label => {
                label.classList.remove('highlighted');
            });
            console.log(`🧹 Campos resaltados limpiados en:`, root);
        }

        // Exponer las funciones en window para que estén disponibles globalmente
        window.setupLabLabelClickHandlers = setupLabLabelClickHandlers;
        window.getHighlightedFields = getHighlightedFields;
        window.applyHighlightedFields = applyHighlightedFields;
        window.clearHighlightedFields = clearHighlightedFields;
        
        // Configurar los event listeners para los labels de laboratorio
        setupLabLabelClickHandlers();
        
        // Debug: Verificar que los labels estén disponibles
        setTimeout(() => {
            const labLabels = document.querySelectorAll('.lab-grid .form-group label');
            console.log(`🔍 Labels de laboratorio encontrados: ${labLabels.length}`);
            labLabels.forEach((label, index) => {
                console.log(`  ${index + 1}. ${label.textContent.trim()} (clickeable: ${label.style.cursor === 'pointer'})`);
            });
        }, 500);
    });
    </script>
    
    <!-- Script de fallback para iconos - Versión mejorada sin duplicación -->
    <script>
        (function(){
            // Crear un elemento de prueba para verificar si Font Awesome está disponible
            const probe = document.createElement('i');
            probe.className = 'fa-solid fa-check';
            probe.style.position = 'absolute';
            probe.style.left = '-9999px';
            document.body.appendChild(probe);
            
            // Verificar la familia de fuentes del pseudo-elemento ::before
            const computedBefore = getComputedStyle(probe, '::before').fontFamily || '';
            const computedElement = getComputedStyle(probe).fontFamily || '';
            document.body.removeChild(probe);
            
            // Si Font Awesome NO está cargado, añadir clase 'no-fa' y cargar CSS de fallbacks
            if (!/Font Awesome/i.test(computedBefore) && !/Font Awesome/i.test(computedElement)) {
                console.warn('⚠️ Font Awesome no detectado, cargando fallbacks...');
                document.documentElement.classList.add('no-fa');
                
                // Cargar CSS de fallbacks SOLO si hace falta
                if (!document.querySelector('link[href*="icon-fallbacks"]')) {
                    const link = document.createElement('link');
                    link.rel = 'stylesheet';
                    link.href = 'css/icon-fallbacks.css';
                    document.head.appendChild(link);
                    console.log('📄 CSS de fallbacks cargado');
                }
            } else {
                console.log('✅ Font Awesome cargado correctamente');
            }
        })();
    </script>
</body>
</html> 