<!-- Componente Sidebar -->
<aside class="sidebar">
    <div class="sidebar-content" id="sidebar-content">
        <!-- El contenido se carga dinámicamente -->
    </div>
</aside>

<style>
/* Estilos del Sidebar */
.sidebar {
    width: 350px;
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    border-right: 1px solid #e2e8f0;
    height: 100vh;
    overflow-y: auto;
    position: fixed;
    left: 0;
    top: 0;
    z-index: 100;
    box-shadow: 2px 0 10px rgba(0, 0, 0, 0.05);
}

.sidebar-content {
    padding: 20px;
}

.patient-data-container {
    background: white;
    border-radius: 16px;
    padding: 25px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    border: 1px solid #e2e8f0;
}

.patient-section {
    margin-bottom: 25px;
}

.patient-section h3 {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    margin: -25px -25px 20px -25px;
    padding: 20px 25px;
    font-size: 1.3em;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 12px;
    border-radius: 16px 16px 0 0;
}

.patient-section h3 i {
    font-size: 1.2em;
}

.editable-field {
    margin-bottom: 18px;
}

.editable-field label {
    display: block;
    margin-bottom: 6px;
    font-weight: 600;
    color: #374151;
    font-size: 0.95em;
}

.editable-field input,
.editable-field textarea {
    width: 100%;
    padding: 10px 12px;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    font-size: 14px;
    transition: border-color 0.3s ease;
    font-family: inherit;
    box-sizing: border-box;
}

.editable-field input:focus,
.editable-field textarea:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.editable-field input:disabled,
.editable-field textarea:disabled {
    background-color: #f9fafb;
    color: #6b7280;
    cursor: not-allowed;
}

.section-actions {
    margin-top: 20px;
    padding-top: 15px;
    border-top: 1px solid #e5e7eb;
    display: flex;
    gap: 10px;
    justify-content: flex-end;
}

.section-actions.hidden {
    display: none;
}

.btn-save-section {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.btn-save-section:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
}

.btn-edit-sidebar {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 20px;
}

.btn-edit-sidebar:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
}

.btn-edit-sidebar.editing {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
}

/* Responsive */
@media (max-width: 768px) {
    .sidebar {
        width: 100%;
        height: auto;
        position: relative;
        border-right: none;
        border-bottom: 1px solid #e2e8f0;
    }
    
    .sidebar-content {
        padding: 15px;
    }
    
    .patient-data-container {
        padding: 20px;
    }
    
    .patient-section h3 {
        margin: -20px -20px 15px -20px;
        padding: 15px 20px;
        font-size: 1.2em;
    }
}
</style>

<script>
// Funcionalidad del Sidebar
class SidebarComponent {
    constructor() {
        this.init();
    }

    init() {
        this.setupEventListeners();
    }

    setupEventListeners() {
        // Event listeners se configuran dinámicamente cuando se carga el contenido
    }

    // Método para renderizar los datos del paciente
    renderPatientData(patient) {
        const sidebarContent = document.getElementById('sidebar-content');
        if (!sidebarContent) return;

        sidebarContent.innerHTML = `
            <div class="patient-data-container">
                <div class="patient-section" data-section="personal">
                    <h3><i class="fas fa-user"></i> Datos Personales</h3>
                    ${this.renderEditableField('Nombre', 'edit-nombre', patient.nombre || patient.Nombre)}
                    ${this.renderEditableField('Apellido', 'edit-apellido', patient.apellido || patient.Apellido)}
                    ${this.renderEditableField('DNI', 'edit-dni', patient.dni || patient.DNI)}
                    ${this.renderEditableField('N° Afiliado', 'edit-numeroAfiliado', patient.numeroAfiliado || patient.NumeroAfiliado)}
                    ${this.renderEditableField('Obra Social', 'edit-obraSocial', patient.obraSocial || patient.ObraSocial)}
                    ${this.renderEditableField('Teléfono', 'edit-telefono', patient.telefono || patient.Telefono, 'tel')}
                    ${this.renderEditableField('Email', 'edit-email', patient.email || patient.Email, 'email')}
                    ${this.renderDateField('Fecha de Nacimiento', 'edit-fechaNacimiento', patient.fechaNacimiento || patient.FechaNacimiento)}
                    ${this.renderReadOnlyField('Edad', 'edit-edad', patient.edad || patient.Edad || '')}
                    ${this.renderEditableField('Peso (kg)', 'edit-peso', patient.peso || patient.Peso, 'number')}
                    ${this.renderEditableField('Altura (cm)', 'edit-altura', patient.altura || patient.Altura, 'number')}
                    ${this.renderCheckboxField('Particular', 'edit-particular', patient.particular || patient.Particular)}
                    <div class="section-actions hidden">
                        <button class="btn-save-section" onclick="sidebarComponent.saveSection('personal')">
                            <i class="fas fa-save"></i> Guardar
                        </button>
                    </div>
                </div>
                <textarea id="edit-medicacion" style="display:none;">${patient.medicacion || patient.Medicacion || ''}</textarea>
                <textarea id="edit-antecedentes" style="display:none;">${patient.antecedentes || patient.Antecedentes || ''}</textarea>
            </div>
        `;

        this.setupAgeCalculation();
        this.setupEditButton();
    }

    renderEditableField(label, id, value = '', type = 'text') {
        return `
            <div class="editable-field">
                <label>${label}:</label>
                <input type="${type}" id="${id}" value="${value || ''}" placeholder="${label}" disabled>
            </div>
        `;
    }

    renderDateField(label, id, value) {
        return `
            <div class="editable-field">
                <label>${label}:</label>
                <input type="date" id="${id}" value="${this.formatDateForInput(value)}" disabled>
            </div>
        `;
    }

    renderReadOnlyField(label, id, value) {
        return `
            <div class="editable-field">
                <label>${label}:</label>
                <input type="text" id="${id}" value="${value || ''}" readonly style="background:#f3f4f6;color:#6b7280;">
            </div>
        `;
    }

    renderCheckboxField(label, id, checked) {
        return `
            <div class="editable-field">
                <label>${label}:</label>
                <div style="display:flex;align-items:center;gap:10px;">
                    <input type="checkbox" id="${id}" ${checked ? 'checked' : ''} disabled style="transform:scale(1.2);">
                    <span style="color:#6b7280;font-size:.9em;">Marcar si es paciente particular</span>
                </div>
            </div>
        `;
    }

    setupAgeCalculation() {
        const fechaNacimiento = document.getElementById('edit-fechaNacimiento');
        const edad = document.getElementById('edit-edad');

        if (fechaNacimiento && edad) {
            fechaNacimiento.addEventListener('change', () => {
                if (!fechaNacimiento.value) {
                    edad.value = '';
                    return;
                }

                const birthDate = new Date(fechaNacimiento.value);
                const now = new Date();
                let age = now.getFullYear() - birthDate.getFullYear();
                const monthDiff = now.getMonth() - birthDate.getMonth();

                if (monthDiff < 0 || (monthDiff === 0 && now.getDate() < birthDate.getDate())) {
                    age--;
                }

                edad.value = age;
            });
        }
    }

    setupEditButton() {
        const editBtn = document.createElement('button');
        editBtn.className = 'btn-edit-sidebar';
        editBtn.innerHTML = '<i class="fas fa-edit"></i> Editar Datos';
        editBtn.onclick = () => this.toggleEditMode('personal');

        const sidebarContent = document.getElementById('sidebar-content');
        if (sidebarContent) {
            sidebarContent.insertBefore(editBtn, sidebarContent.firstChild);
        }
    }

    toggleEditMode(section) {
        const sectionElement = document.querySelector(`[data-section="${section}"]`);
        if (!sectionElement) return;

        const fields = this.getSectionFields(section);
        if (!fields.length) return;

        const isEditing = !fields[0].disabled;
        const editBtn = document.querySelector('.btn-edit-sidebar');
        const saveWrap = sectionElement.querySelector('.section-actions');

        fields.forEach(field => field.disabled = isEditing);

        if (editBtn) {
            editBtn.innerHTML = isEditing ? 
                '<i class="fas fa-edit"></i> Editar Datos' : 
                '<i class="fas fa-times"></i> Cancelar';
            editBtn.classList.toggle('editing', !isEditing);
        }

        if (saveWrap) {
            saveWrap.classList.toggle('hidden', isEditing);
        }
    }

    getSectionFields(section) {
        const fieldIds = {
            personal: [
                'edit-nombre', 'edit-apellido', 'edit-dni', 'edit-numeroAfiliado', 
                'edit-obraSocial', 'edit-telefono', 'edit-email', 'edit-fechaNacimiento', 
                'edit-peso', 'edit-altura', 'edit-particular'
            ],
            medicacion: ['edit-medicacion'],
            antecedentes: ['edit-antecedentes']
        };

        const ids = fieldIds[section] || [];
        return ids.map(id => document.getElementById(id)).filter(Boolean);
    }

    async saveSection(section) {
        const patientId = this.getPatientIdFromUrl();
        if (!patientId) {
            this.showToast('Error: No se encontró ID del paciente', 'error');
            return;
        }

        const data = this.buildSectionData(section);
        if (!data) {
            this.showToast('Sección no reconocida', 'error');
            return;
        }

        try {
            // Aquí se haría la llamada a la API
            // await apiClient.updatePatient(patientId, data);
            this.showToast('Guardado con éxito', 'success');
            this.toggleEditMode(section);
        } catch (error) {
            this.showToast(error.message || 'Error al guardar', 'error');
        }
    }

    buildSectionData(section) {
        const getValue = (id) => document.getElementById(id)?.value?.trim() || '';
        const getFloatValue = (id) => {
            const value = document.getElementById(id)?.value;
            return value ? parseFloat(value) : null;
        };
        const getIntValue = (id) => {
            const value = document.getElementById(id)?.value;
            return value ? parseInt(value, 10) : null;
        };
        const getCheckboxValue = (id) => !!document.getElementById(id)?.checked;

        switch (section) {
            case 'personal':
                return {
                    nombre: getValue('edit-nombre'),
                    apellido: getValue('edit-apellido'),
                    dni: getValue('edit-dni'),
                    numeroAfiliado: getValue('edit-numeroAfiliado') || null,
                    obraSocial: getValue('edit-obraSocial') || null,
                    telefono: getValue('edit-telefono') || null,
                    email: getValue('edit-email') || null,
                    fechaNacimiento: getValue('edit-fechaNacimiento') || null,
                    peso: getFloatValue('edit-peso'),
                    altura: getIntValue('edit-altura'),
                    particular: getCheckboxValue('edit-particular')
                };
            case 'medicacion':
                return {
                    medicacion: getValue('edit-medicacion')
                };
            case 'antecedentes':
                return {
                    antecedentes: getValue('edit-antecedentes')
                };
            default:
                return null;
        }
    }

    formatDateForInput(value) {
        if (!value) return '';
        if (typeof value === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(value)) return value;
        if (typeof value === 'string' && value.includes('T')) return value.split('T')[0];
        const date = new Date(value);
        return isNaN(date) ? '' : date.toISOString().split('T')[0];
    }

    getPatientIdFromUrl() {
        return new URLSearchParams(window.location.search).get('id');
    }

    showToast(message, type) {
        // Implementar notificación toast
        console.log(`${type.toUpperCase()}: ${message}`);
    }
}

// Instancia global del componente
let sidebarComponent;

// Inicializar cuando el DOM esté listo
document.addEventListener('DOMContentLoaded', () => {
    sidebarComponent = new SidebarComponent();
});
</script>
